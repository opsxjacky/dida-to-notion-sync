# 滴答清单同步到 Notion 设计文档

## 1. 项目概述

**项目名称**：Dida-to-Notion Sync  
**创建日期**：2026-01-06  
**状态**：已完成 ✅

### 1.1 背景

在日常工作和生活中，用户可能在滴答清单（TickTick）中管理任务，但需要将这些任务同步到 Notion 中进行更详细的规划和记录。手动复制任务不仅耗时，还容易出错，因此需要一个自动化工具来保持两个平台之间的数据同步。

### 1.2 目标

开发一个自动化工具，实现滴答清单任务向 Notion 的单向同步，保持任务数据的一致性，并提供灵活的配置选项。

---

## 2. 需求分析

### 2.1 同步范围

根据当前实现，同步以下数据：

- [x] 待办任务（未完成）
- [x] 已完成任务
- [x] 项目/清单结构
- [x] 优先级
- [x] 截止日期
- [ ] 提醒时间
- [x] 子任务
- [x] 任务描述/备注
- [ ] 附件
- [x] 标签
- [ ] 其他：___

### 2.2 同步方向

- [x] 单向：滴答清单 → Notion
- [x] 状态反向同步（Notion → 滴答清单）
- [x] 自动完成检测（滴答清单已删除/完成 → Notion 标记完成）

### 2.3 同步频率

- [x] 手动触发（一次性）
- [ ] 定时同步（如每小时/每天）
- [ ] 实时同步
- [ ] 其他：___

### 2.4 冲突处理策略

- 使用滴答清单ID在Notion中创建唯一标识，避免重复创建
- 当Notion中的任务状态为"完成"而滴答清单中为"未完成"时，会自动更新滴答清单任务状态
- **当任务在Notion中存在但在滴答清单中找不到时（已删除或已完成），自动在Notion中将该任务标记为"完成"状态**
- 子任务与父任务的关联通过三轮同步确保正确建立
- 通过ID精确匹配任务，避免重复同步

---

## 3. 数据映射

### 3.1 滴答清单数据结构

| 滴答清单字段 | 类型 | 说明 |
|-------------|------|------|
| id | string | 任务唯一标识 |
| title | string | 任务标题 |
| content | string | 任务描述 |
| priority | int | 优先级 (0:无, 1:低, 3:中, 5:高) |
| dueDate | string | 截止日期 |
| tags | []string | 标签列表 |
| projectId | string | 所属项目 |
| status | int | 状态 (0:未完成, 2:已完成) |
| parentId | string | 父任务ID（如果是子任务） |
| reminders | []string | 提醒时间列表 |
| items | []CheckItem | 清单项/检查项 |
| childIds | []string | 子任务ID列表 |
| createdTime | time.Time | 创建时间 |
| modifiedTime | time.Time | 修改时间 |

### 3.2 Notion 数据库结构

| Notion 属性 | 类型 | 对应滴答字段 | 说明 |
|------------|------|-------------|------|
| 名称 | Title | title | 任务标题 |
| 状态 | Status | status | 映射为"完成"/"未开始" |
| 日期 | Date | dueDate | 截止日期 |
| 项目 | Select | projectName | 从projectId映射的项目名称 |
| 标签 | Select | priority | 优先级映射为"高/中/低优先级" |
| 描述 | Rich Text | content | 任务描述（截断至2000字符） |
| 滴答ID | Rich Text | id | 用于去重的唯一标识 |
| 父任务 | Relation | parentId | 与父任务页面的关联 |
| 子任务 | Relation | childIds | 与子任务页面的关联 |

---

## 4. 技术方案

### 4.1 技术选型

- [x] Go (Golang)
- [ ] Python
- [ ] Node.js / TypeScript
- [ ] 其他：___

### 4.2 API 信息

#### 滴答清单 API

- API 文档：https://developer.dida365.com/
- 认证方式：OAuth 2.0
- 认证流程：使用 OAuth 授权码流程获取访问令牌
- API 端点：
  - 获取项目：`GET /open/v1/project`
  - 获取任务：`GET /open/v1/project/{project_id}/data` (获取特定项目的所有任务)
  - 获取单个任务：`GET /open/v1/project/{project_id}/task/{task_id}` (用于补充获取缺失的子任务)
  - 批量更新任务：`POST /open/v1/project/{project_id}/batch/task`
  - 作用域：`tasks:read tasks:write`
- **注意**：`/project/{project_id}/data` 接口不会返回所有子任务，需要通过父任务的 `childIds` 字段获取子任务ID，然后使用单个任务接口补充获取

#### Notion API

- API 文档：https://developers.notion.com/
- 认证方式：Integration Token
- API 端点：
  - 查询页面：`POST /v1/databases/{database_id}/query`
  - 创建页面：`POST /v1/pages`
  - 更新页面：`PATCH /v1/pages/{page_id}`
  - API 版本：`2022-06-28`

### 4.3 系统架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   滴答清单 API   │ <──>│    同步脚本     │<──> │   Notion API    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                              │
                              v
                        ┌───────────┐
                        │ 本地缓存/配置 │
                        │ (.env, .token) │
                        └───────────┘
```

### 4.4 核心流程

1. 从 .env 文件加载配置（API密钥、数据库ID等）
2. 检查并加载本地OAuth令牌，如不存在则启动OAuth授权流程：
   - 生成授权URL
   - 启动本地HTTP服务器监听回调
   - 自动打开浏览器进行授权
   - 交换授权码为访问令牌
3. 从滴答清单获取项目列表，构建项目ID→名称映射
4. 从滴答清单获取所有任务列表（遍历所有项目和收件箱）
5. **补充获取缺失的子任务**：
   - 检查父任务的 `childIds` 中是否有子任务未被API返回
   - 使用单个任务API逐个获取缺失的子任务
6. 三轮同步处理任务：
   - 第一轮：创建/更新所有任务页面，建立滴答ID→Notion页面ID映射
   - 第二轮：更新子任务的父任务关联
   - 第三轮：更新父任务的子任务列表
7. 检查已完成的任务：
   - **如果Notion中的任务在滴答清单中不存在（已删除或完成），在Notion中标记为"完成"**
   - 如果Notion中已完成但滴答清单中未完成，将完成状态同步回滴答清单
8. 输出同步统计结果（新增、更新、跳过、失败、标记完成的数量）
9. 应用API限流控制（350ms延迟）以避免请求频率限制

---

## 5. 部署方案

- [x] 本地可执行文件运行
- [ ] 本地脚本手动运行
- [ ] 本地 cron 定时任务
- [ ] 云函数（AWS Lambda / Vercel / 阿里云函数计算）
- [ ] 自建服务器
- [ ] 第三方自动化平台（Zapier / n8n / Make）

---

## 6. 其他想法和备注

当前实现已支持：
- OAuth 2.0 认证流程，自动处理令牌获取和保存
- 滴答清单项目与 Notion 选择字段的映射
- 任务优先级映射为 Notion 标签（0:无优先级, 1:低优先级, 3:中优先级, 5:高优先级）
- 截止日期映射到 Notion 日期字段
- 任务状态双向同步：
  - Notion 完成 → 同步到滴答清单
  - 滴答清单中已删除/完成 → Notion 中自动标记完成
- 父子任务关系维护
- **子任务完整同步**：自动检测并补充获取API未返回的子任务
- 重复任务检测（通过滴答ID）
- API 限流控制（350ms延迟）
- 任务标签同步（使用优先级字段）
- 子任务双向关联（父任务关联子任务，子任务关联父任务）
- 批量更新API使用以提高效率

可能的改进方向：
- 添加定时同步功能（通过cron或其他调度器）
- 增加增量同步（仅同步变更的任务）
- 增加更多字段映射（如附件、提醒时间等）
- 增加错误重试机制
- 增加同步日志记录
- 支持更多同步选项（如仅同步特定项目）
- 增加同步进度显示

---

## 7. 待办事项

- [x] 完善需求细节
- [x] 获取滴答清单 API 访问权限
- [x] 创建 Notion Integration
- [x] 创建目标 Notion 数据库
- [x] 开发同步脚本
- [x] 测试
- [x] 部署
- [x] 实现反向完成检测（滴答清单已删除/完成 → Notion 标记完成）
- [ ] 添加增量同步功能
- [ ] 优化性能（并行处理）
- [ ] 添加更多同步选项（如仅同步特定项目）
- [ ] 添加更详细的日志记录
- [ ] 增加错误重试机制
- [ ] 实现定时同步功能
- [ ] 增加同步进度显示

---

## 更新记录

| 日期 | 更新内容 | 作者 |
|------|---------|------|
| 2026-01-06 | 创建初始设计文档 | - |
| 2026-01-06 | 基于实际实现更新文档，包括需求分析、技术方案、数据映射和部署方案 | - |
| 2026-01-06 | 全面更新设计文档，反映最新实现细节和功能特性 | - |
| 2026-01-06 | 实现反向完成检测功能：当任务在Notion中存在但在滴答清单中找不到时，自动在Notion中标记为完成 | - |
| 2026-01-07 | 修复子任务同步问题：滴答清单API不会返回所有子任务，添加 `fetchMissingSubtasks` 函数自动检测并补充获取缺失的子任务 | - |